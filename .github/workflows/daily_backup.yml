- name: Install Supabase CLI
  run: |
    CLI_VERSION="1.46.0"
    OS="linux"
    ARCH="amd64"
    curl -sL "https://github.com/supabase/cli/releases/download/v${CLI_VERSION}/supabase_${OS}_${ARCH}.tar.gz" -o supabase.tar.gz
    tar -xzf supabase.tar.gz
    mv supabase /usr/local/bin/supabase
    chmod +x /usr/local/bin/supabase
    supabase --version
  env:
    SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        
      # Descargar el backup de la base de datos de GC-2
      - name: Dump GC-2 database
        run: supabase db dump --data-only -f gc2-backup-$(date +'%Y-%m-%d').sql

      # Configurar la clave SSH para Hostinger
      - name: Setup SSH key for Hostinger
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}

      # Transferir el backup y limpiar archivos viejos en Hostinger
      - name: Transfer and cleanup GC-2 backups on Hostinger
        run: |
          BACKUP_FILE=gc2-backup-$(date +'%Y-%m-%d').sql
          rsync -avz \
            -e "ssh -p 65002 -o StrictHostKeyChecking=no" \
            $BACKUP_FILE \
            ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_HOST }}:/home/${{ secrets.HOSTINGER_SSH_USER }}/public_html/Backups/

          ssh -p 65002 -o StrictHostKeyChecking=no ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_HOST }} << 'EOF'
            cd /home/${{ secrets.HOSTINGER_SSH_USER }}/public_html/Backups/
            # Eliminar solo los backups de GC-2 de mas de 7 dias
            find . -name "gc2-backup-*.sql" -mtime +7 -delete
            echo "Limpieza de backups de GC-2 completada."
          EOF
